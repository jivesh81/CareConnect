import React, { useState } from 'react';
import { Activity, Calendar, FileText, User, Clock, AlertCircle, CheckCircle, Phone, MessageSquare, Plus, History } from 'lucide-react';

export default function CareConnectDemo() {
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [patientName, setPatientName] = useState('');
  const [patientAge, setPatientAge] = useState('');
  const [patientData, setPatientData] = useState(null);
  const [step, setStep] = useState(0);
  const [symptoms, setSymptoms] = useState('');
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [analysisResult, setAnalysisResult] = useState(null);
  const [appointment, setAppointment] = useState(null);
  const [showReportEntry, setShowReportEntry] = useState(false);
  const [newReport, setNewReport] = useState({
    date: '',
    diagnosis: '',
    prescription: '',
    notes: ''
  });

  // Simulated patient database
  const [patientDatabase, setPatientDatabase] = useState({
    'sarah johnson': {
      age: 45,
      conditions: ["Type 2 Diabetes", "Hypertension"],
      lastVisit: "Oct 15, 2024",
      reports: [
        {
          date: "Oct 15, 2024",
          diagnosis: "Type 2 Diabetes - Controlled",
          prescription: "Metformin 500mg, Lisinopril 10mg",
          notes: "Blood sugar levels stable. Continue current medication."
        },
        {
          date: "Aug 22, 2024",
          diagnosis: "Hypertension Follow-up",
          prescription: "Lisinopril 10mg",
          notes: "Blood pressure reading 128/82. Good progress."
        }
      ]
    },
    'john doe': {
      age: 32,
      conditions: ["Asthma"],
      lastVisit: "Nov 20, 2024",
      reports: [
        {
          date: "Nov 20, 2024",
          diagnosis: "Mild Asthma",
          prescription: "Albuterol inhaler as needed",
          notes: "Symptoms controlled with current treatment."
        }
      ]
    }
  });

  const handleLogin = () => {
    if (patientName.trim() && patientAge.trim()) {
      const normalizedName = patientName.toLowerCase().trim();
      const existingPatient = patientDatabase[normalizedName];
      
      if (existingPatient) {
        setPatientData({
          name: patientName,
          age: existingPatient.age,
          conditions: existingPatient.conditions,
          lastVisit: existingPatient.lastVisit,
          reports: existingPatient.reports
        });
      } else {
        setPatientData({
          name: patientName,
          age: parseInt(patientAge),
          conditions: [],
          lastVisit: "First Visit",
          reports: []
        });
      }
      setIsLoggedIn(true);
      setStep(1);
    }
  };

  const handleSymptomSubmit = () => {
    setIsAnalyzing(true);
    setStep(2);
    
    setTimeout(() => {
      const hasDiabetes = patientData.conditions.some(c => c.toLowerCase().includes('diabetes'));
      setAnalysisResult({
        severity: hasDiabetes ? "Medium" : "Low",
        urgency: hasDiabetes ? "Moderate Priority" : "Low Priority",
        recommendation: hasDiabetes 
          ? "Consultation with Endocrinologist recommended" 
          : "General practitioner consultation recommended",
        riskFactors: hasDiabetes 
          ? ["Existing diabetes condition", "Elevated blood sugar symptoms"]
          : ["No major risk factors identified"],
        matchedSpecialist: hasDiabetes 
          ? "Dr. Emily Chen - Endocrinologist"
          : "Dr. Michael Smith - General Practitioner"
      });
      setIsAnalyzing(false);
    }, 2500);
  };

  const handleBookAppointment = () => {
    setStep(3);
    setTimeout(() => {
      setAppointment({
        doctor: analysisResult.matchedSpecialist.split(' - ')[0],
        specialty: analysisResult.matchedSpecialist.split(' - ')[1],
        date: "December 10, 2024",
        time: "2:30 PM",
        location: "City Medical Center - Room 304",
        confirmationCode: `CC-2024-${Math.floor(1000 + Math.random() * 9000)}`
      });
    }, 2000);
  };

  const handleAddReport = () => {
    if (newReport.date && newReport.diagnosis) {
      const updatedReports = [...(patientData.reports || []), newReport];
      const normalizedName = patientData.name.toLowerCase().trim();
      
      setPatientDatabase(prev => ({
        ...prev,
        [normalizedName]: {
          ...prev[normalizedName],
          age: patientData.age,
          conditions: patientData.conditions,
          lastVisit: newReport.date,
          reports: updatedReports
        }
      }));
      
      setPatientData(prev => ({
        ...prev,
        reports: updatedReports,
        lastVisit: newReport.date
      }));
      
      setNewReport({ date: '', diagnosis: '', prescription: '', notes: '' });
      setShowReportEntry(false);
      alert('Report added successfully!');
    }
  };

  const resetDemo = () => {
    setStep(1);
    setSymptoms('');
    setAnalysisResult(null);
    setAppointment(null);
    setIsAnalyzing(false);
  };

  const logout = () => {
    setIsLoggedIn(false);
    setPatientName('');
    setPatientAge('');
    setPatientData(null);
    setStep(0);
    setSymptoms('');
    setAnalysisResult(null);
    setAppointment(null);
  };

  if (!isLoggedIn) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-green-50 to-green-100 p-4 flex items-center justify-center">
        <div className="max-w-md w-full">
          <div className="bg-white rounded-2xl shadow-2xl p-8">
            <div className="text-center mb-8">
              <div className="bg-green-600 text-white w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <Activity size={40} />
              </div>
              <h1 className="text-3xl font-bold text-gray-800 mb-2">CareConnect</h1>
              <p className="text-gray-600">Your Instant Bridge to Personalized Care</p>
            </div>

            <div className="space-y-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Patient Name
                </label>
                <input
                  type="text"
                  value={patientName}
                  onChange={(e) => setPatientName(e.target.value)}
                  placeholder="Enter your full name"
                  className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Age
                </label>
                <input
                  type="number"
                  value={patientAge}
                  onChange={(e) => setPatientAge(e.target.value)}
                  placeholder="Enter your age"
                  className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
                />
              </div>

              <button
                onClick={handleLogin}
                disabled={!patientName.trim() || !patientAge.trim()}
                className="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
              >
                Continue
              </button>

              <div className="bg-green-50 border-l-4 border-green-600 p-4 rounded">
                <p className="text-xs text-gray-700">
                  <strong>Demo Patients:</strong> Try "Sarah Johnson" or "John Doe" to see existing records, or enter any name for a new patient.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-green-50 to-green-100 p-4">
      <div className="max-w-6xl mx-auto">
        <div className="bg-green-800 text-white rounded-t-2xl p-6 shadow-lg">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold mb-2">CareConnect</h1>
              <p className="text-green-100">Your Instant Bridge to Personalized Care</p>
            </div>
            <div className="flex items-center gap-4">
              <div className="bg-white text-green-800 p-3 rounded-full">
                <Activity size={32} />
              </div>
              <button
                onClick={logout}
                className="bg-green-700 hover:bg-green-600 px-4 py-2 rounded-lg text-sm transition"
              >
                Logout
              </button>
            </div>
          </div>
        </div>

        {step >= 1 && (
          <div className="bg-white p-6 shadow-md">
            <div className="flex items-center justify-between max-w-2xl mx-auto">
              <div className="flex flex-col items-center flex-1">
                <div className={`w-12 h-12 rounded-full flex items-center justify-center ${step >= 1 ? 'bg-green-600 text-white' : 'bg-gray-300 text-gray-600'}`}>
                  <MessageSquare size={24} />
                </div>
                <span className="text-sm mt-2 font-medium">Report</span>
              </div>
              <div className={`flex-1 h-1 ${step >= 2 ? 'bg-green-600' : 'bg-gray-300'}`}></div>
              <div className="flex flex-col items-center flex-1">
                <div className={`w-12 h-12 rounded-full flex items-center justify-center ${step >= 2 ? 'bg-green-600 text-white' : 'bg-gray-300 text-gray-600'}`}>
                  <Activity size={24} />
                </div>
                <span className="text-sm mt-2 font-medium">Analyze</span>
              </div>
              <div className={`flex-1 h-1 ${step >= 3 ? 'bg-green-600' : 'bg-gray-300'}`}></div>
              <div className="flex flex-col items-center flex-1">
                <div className={`w-12 h-12 rounded-full flex items-center justify-center ${step >= 3 ? 'bg-green-600 text-white' : 'bg-gray-300 text-gray-600'}`}>
                  <Calendar size={24} />
                </div>
                <span className="text-sm mt-2 font-medium">Connect</span>
              </div>
            </div>
          </div>
        )}

        <div className="bg-white rounded-lg shadow-md p-6 mt-6">
          <div className="flex items-start justify-between">
            <div className="flex items-start gap-4">
              <div className="bg-green-100 p-3 rounded-full">
                <User size={32} className="text-green-700" />
              </div>
              <div className="flex-1">
                <h3 className="text-xl font-bold text-gray-800">{patientData.name}</h3>
                <p className="text-gray-600">Age: {patientData.age} | Last Visit: {patientData.lastVisit}</p>
                {patientData.conditions.length > 0 ? (
                  <div className="mt-2 flex flex-wrap gap-2">
                    {patientData.conditions.map((condition, idx) => (
                      <span key={idx} className="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm">
                        {condition}
                      </span>
                    ))}
                  </div>
                ) : (
                  <p className="text-gray-500 mt-2 text-sm">No existing conditions recorded</p>
                )}
              </div>
            </div>
            <button
              onClick={() => setShowReportEntry(!showReportEntry)}
              className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2 text-sm"
            >
              <Plus size={18} />
              Add Report
            </button>
          </div>

          {showReportEntry && (
            <div className="mt-6 border-t-2 border-gray-200 pt-6">
              <h4 className="text-lg font-bold text-gray-800 mb-4">Add New Medical Report</h4>
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Date</label>
                  <input
                    type="date"
                    value={newReport.date}
                    onChange={(e) => setNewReport({...newReport, date: e.target.value})}
                    className="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Diagnosis</label>
                  <input
                    type="text"
                    value={newReport.diagnosis}
                    onChange={(e) => setNewReport({...newReport, diagnosis: e.target.value})}
                    placeholder="e.g., Type 2 Diabetes"
                    className="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Prescription</label>
                  <input
                    type="text"
                    value={newReport.prescription}
                    onChange={(e) => setNewReport({...newReport, prescription: e.target.value})}
                    placeholder="e.g., Metformin 500mg"
                    className="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                  <input
                    type="text"
                    value={newReport.notes}
                    onChange={(e) => setNewReport({...newReport, notes: e.target.value})}
                    placeholder="Additional notes"
                    className="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
                  />
                </div>
              </div>
              <div className="flex gap-4 mt-4">
                <button
                  onClick={handleAddReport}
                  className="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition"
                >
                  Save Report
                </button>
                <button
                  onClick={() => {
                    setShowReportEntry(false);
                    setNewReport({ date: '', diagnosis: '', prescription: '', notes: '' });
                  }}
                  className="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition"
                >
                  Cancel
                </button>
              </div>
            </div>
          )}

          <div className="mt-6 border-t-2 border-gray-200 pt-6">
            <div className="flex items-center gap-2 mb-4">
              <History size={24} className="text-green-700" />
              <h4 className="text-lg font-bold text-gray-800">Medical History</h4>
            </div>
            
            {patientData.reports && patientData.reports.length > 0 ? (
              <div className="space-y-4">
                {patientData.reports.map((report, idx) => (
                  <div key={idx} className="bg-gray-50 border-2 border-gray-200 rounded-lg p-4">
                    <div className="flex items-start justify-between mb-2">
                      <h5 className="font-bold text-gray-800">{report.diagnosis}</h5>
                      <span className="text-sm text-gray-600">{report.date}</span>
                    </div>
                    <p className="text-sm text-gray-700 mb-2">
                      <strong>Prescription:</strong> {report.prescription}
                    </p>
                    <p className="text-sm text-gray-600">{report.notes}</p>
                  </div>
                ))}
              </div>
            ) : (
              <div className="bg-gray-50 border-2 border-gray-200 rounded-lg p-8 text-center">
                <FileText size={48} className="text-gray-400 mx-auto mb-3" />
                <p className="text-gray-600 font-medium">No medical history available</p>
                <p className="text-sm text-gray-500 mt-1">This appears to be your first visit. Add reports above to build your medical history.</p>
              </div>
            )}
          </div>
        </div>

        <div className="bg-white rounded-lg shadow-lg p-8 mt-6 min-h-96">
          {step === 1 && (
            <div className="space-y-6">
              <div>
                <h2 className="text-2xl font-bold text-gray-800 mb-2">Step 1: Report Your Symptoms</h2>
                <p className="text-gray-600 mb-6">Describe how you're feeling. You can type or use voice input.</p>
              </div>

              <div className="space-y-4">
                <label className="block text-sm font-medium text-gray-700">
                  Describe your symptoms:
                </label>
                <textarea
                  value={symptoms}
                  onChange={(e) => setSymptoms(e.target.value)}
                  placeholder="E.g., I've been feeling dizzy and experiencing increased thirst for the past 3 days. My energy levels are very low and I've had frequent urination."
                  className="w-full h-40 p-4 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
                />
                
                <div className="flex gap-4">
                  <button
                    onClick={handleSymptomSubmit}
                    disabled={!symptoms.trim()}
                    className="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                  >
                    Submit Symptoms
                  </button>
                  <button className="bg-green-100 text-green-700 py-3 px-6 rounded-lg font-medium hover:bg-green-200 transition flex items-center gap-2">
                    <Phone size={20} />
                    Voice Input
                  </button>
                </div>
              </div>

              <div className="bg-green-50 border-l-4 border-green-600 p-4 rounded">
                <p className="text-sm text-gray-700">
                  <strong>Privacy Notice:</strong> Your health information is encrypted and HIPAA-compliant. Only authorized healthcare providers will have access.
                </p>
              </div>
            </div>
          )}

          {step === 2 && (
            <div className="space-y-6">
              <div>
                <h2 className="text-2xl font-bold text-gray-800 mb-2">Step 2: AI Analysis in Progress</h2>
                <p className="text-gray-600 mb-6">Analyzing your symptoms with historical health records...</p>
              </div>

              {isAnalyzing ? (
                <div className="flex flex-col items-center justify-center py-12">
                  <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-green-600 mb-4"></div>
                  <p className="text-gray-600 text-lg">Analyzing symptoms...</p>
                  <p className="text-gray-500 text-sm mt-2">Comparing with your medical history</p>
                </div>
              ) : analysisResult && (
                <div className="space-y-6">
                  <div className={`${analysisResult.severity === 'Medium' ? 'bg-yellow-50 border-yellow-400' : 'bg-blue-50 border-blue-400'} border-2 rounded-lg p-6`}>
                    <div className="flex items-center gap-3 mb-4">
                      <AlertCircle size={32} className={analysisResult.severity === 'Medium' ? 'text-yellow-600' : 'text-blue-600'} />
                      <div>
                        <h3 className="text-xl font-bold text-gray-800">Severity: {analysisResult.severity}</h3>
                        <p className="text-gray-600">{analysisResult.urgency}</p>
                      </div>
                    </div>
                  </div>

                  <div className="grid md:grid-cols-2 gap-6">
                    <div className="border-2 border-gray-200 rounded-lg p-6">
                      <h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <FileText size={20} className="text-green-600" />
                        Analysis Results
                      </h4>
                      <p className="text-gray-700 mb-4">{analysisResult.recommendation}</p>
                      <p className="text-sm text-gray-600">
                        <strong>Matched Specialist:</strong><br />
                        {analysisResult.matchedSpecialist}
                      </p>
                    </div>

                    <div className="border-2 border-gray-200 rounded-lg p-6">
                      <h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <AlertCircle size={20} className="text-orange-600" />
                        Risk Factors Identified
                      </h4>
                      <ul className="space-y-2">
                        {analysisResult.riskFactors.map((factor, idx) => (
                          <li key={idx} className="flex items-start gap-2 text-gray-700">
                            <span className="text-orange-600 mt-1">â€¢</span>
                            <span>{factor}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  </div>

                  <button
                    onClick={handleBookAppointment}
                    className="w-full bg-green-600 text-white py-4 px-6 rounded-lg font-medium hover:bg-green-700 transition text-lg"
                  >
                    Book Appointment Now
                  </button>
                </div>
              )}
            </div>
          )}

          {step === 3 && (
            <div className="space-y-6">
              <div>
                <h2 className="text-2xl font-bold text-gray-800 mb-2">Step 3: Appointment Confirmed!</h2>
                <p className="text-gray-600 mb-6">Your appointment has been successfully scheduled</p>
              </div>

              {!appointment ? (
                <div className="flex flex-col items-center justify-center py-12">
                  <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-green-600 mb-4"></div>
                  <p className="text-gray-600 text-lg">Booking appointment...</p>
                </div>
              ) : (
                <div className="space-y-6">
                  <div className="bg-green-50 border-2 border-green-400 rounded-lg p-6">
                    <div className="flex items-center gap-3 mb-6">
                      <CheckCircle size={40} className="text-green-600" />
                      <div>
                        <h3 className="text-2xl font-bold text-gray-800">Confirmed!</h3>
                        <p className="text-gray-600">Confirmation Code: {appointment.confirmationCode}</p>
                      </div>
                    </div>

                    <div className="grid md:grid-cols-2 gap-6">
                      <div className="space-y-4">
                        <div className="flex items-start gap-3">
                          <User size={20} className="text-green-600 mt-1" />
                          <div>
                            <p className="text-sm text-gray-600">Doctor</p>
                            <p className="font-bold text-gray-800">{appointment.doctor}</p>
                            <p className="text-sm text-gray-600">{appointment.specialty}</p>
                          </div>
                        </div>

                        <div className="flex items-start gap-3">
                          <Calendar size={20} className="text-green-600 mt-1" />
                          <div>
                            <p className="text-sm text-gray-600">Date & Time</p>
                            <p className="font-bold text-gray-800">{appointment.date}</p>
                            <p className="text-sm text-gray-600">{appointment.time}</p>
                          </div>
                        </div>
                      </div>

                      <div className="space-y-4">
                        <div className="flex items-start gap-3">
                          <Activity size={20} className="text-green-600 mt-1" />
                          <div>
                            <p className="text-sm text-gray-600">Location</p>
                            <p className="font-bold text-gray-800">{appointment.location}</p>
                          </div>
                        </div>

                        <div className="flex items-start gap-3">
                          <Clock size={20} className="text-green-600 mt-1" />
                          <div>
                            <p className="text-sm text-gray-600">Preparation</p>
                            <p className="text-sm text-gray-700">Please arrive 15 minutes early. Bring your insurance card and ID.</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="bg-blue-50 border-l-4 border-blue-600 p-4 rounded">
                    <p className="text-sm text-gray-700">
                      <strong>Pre-Consultation:</strong> Your symptoms and medical history have been shared with {appointment.doctor} for review before your appointment.
                    </p>
                  </div>

                  <button
                    onClick={resetDemo}
                    className="w-full bg-green-600 text-white py-4 px-6 rounded-lg font-medium hover:bg-green-700 transition text-lg"
                  >
                    Start New Session
                  </button>
                </div>
              )}
            </div>
          )}
        </div>

        <div className="bg-green-800 text-white rounded-b-2xl p-6 shadow-lg mt-6 text-center">
          <p className="text-green-100">
            <strong>CareConnect Demo</strong> - Building a Healthier Future Together
          </p>
          <p className="text-sm text-green-200 mt-2">
            Integrating real-time symptom reporting, historical records, and emergency appointments
          </p>
        </div>
      </div>
    </div>
  );
}
